<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ report_title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" defer></script>
    <style>
        :root {
            --bg-body: #09090b;
            --bg-gradient-1: rgba(127, 90, 240, 0.2);
            --bg-gradient-2: rgba(44, 182, 125, 0.15);
            
            --glass-bg: rgba(20, 20, 25, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            
            --accent: #7f5af0;
            --accent-glow: rgba(127, 90, 240, 0.5);
            --success: #2cb67d;
            
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 0% 0%, var(--bg-gradient-1), transparent 40%),
                radial-gradient(circle at 100% 0%, var(--bg-gradient-2), transparent 40%);
            background-attachment: fixed;
            color: var(--text-main);
            font-family: var(--font-main);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            padding-top: 90px; /* space for fixed nav */
        }

        /* Navbar */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 72px;
            background: rgba(9, 9, 11, 0.7);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-brand h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, #fff, #a1a1aa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-date {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            padding-left: 16px;
            border-left: 1px solid var(--glass-border);
        }

        .nav-links {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.03);
            padding: 4px;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
        }

        .nav-links button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 8px 20px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-links button:hover {
            color: var(--text-main);
        }

        .nav-links button.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px rgba(127, 90, 240, 0.3);
        }

        /* Layout */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 32px 64px;
        }

        .hero {
            margin-bottom: 48px;
            max-width: 800px;
        }

        .hero p {
            font-size: 1.1rem;
            line-height: 1.6;
            color: var(--text-muted);
            margin: 0;
        }

        /* Cards */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: var(--radius-lg);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.03);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .stat-card strong {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        /* Tab Panels */
        .tab-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Filters & Inputs */
        .filters-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--glass-border);
            padding: 24px;
            border-radius: var(--radius-md);
            align-items: start;
        }

        .filter-group {
            min-width: 0; /* Prevent grid blowout */
        }

        #filter-price {
            grid-column: 1;
            grid-row: 2;
        }

        #filter-size {
            grid-column: 2;
            grid-row: 2;
        }

        #filter-score {
            grid-column: 3;
            grid-row: 2;
        }

        @media (max-width: 960px) {
            .filters-bar {
                grid-template-columns: 1fr;
            }
            
            #filter-size, #filter-price, #filter-score {
                grid-column: auto;
                grid-row: auto;
            }
        }

        .comparison-panel {
            padding: 24px;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .comparison-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .comparison-header p {
            margin: 4px 0 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .comparison-search input {
            width: 100%;
        }

        .selected-models {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .selected-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border: 1px solid var(--glass-border);
            border-radius: 999px;
            background: rgba(255,255,255,0.05);
            font-size: 0.8rem;
        }

        .selected-chip button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            line-height: 1;
        }

        .selected-chip button:hover {
            color: var(--text-main);
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .model-option {
            border: 1px solid var(--glass-border);
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .model-option .option-score {
            font-family: var(--font-mono);
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .model-option:hover {
            border-color: var(--glass-highlight);
            transform: translateY(-1px);
        }

        .model-option.selected {
            background: rgba(127, 90, 240, 0.12);
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(127, 90, 240, 0.15);
        }

        .model-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .empty-state {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .comparison-actions {
            display: flex;
            justify-content: center;
        }

        .comparison-actions button {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: 999px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .comparison-actions button:hover {
            border-color: var(--glass-highlight);
            background: rgba(255,255,255,0.08);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        input[type="text"], 
        select, 
        input[type="range"],
        input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus, 
        select:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(127, 90, 240, 0.15);
            background: rgba(0, 0, 0, 0.4);
        }

        .size-filter-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .size-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            flex: 1;
            min-width: 60px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            text-align: center;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-main);
            border-color: var(--glass-highlight);
        }

        .preset-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(127, 90, 240, 0.2);
        }

        .size-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 4px 0;
        }

        .size-inputs input {
            text-align: center;
            font-family: var(--font-mono);
        }

        .size-inputs .separator {
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Dropdown & Checkboxes */
        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .dropdown-btn:hover {
            border-color: var(--glass-highlight);
            background: rgba(255, 255, 255, 0.03);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 220px;
            background: #0c0e14; /* Solid dark bg for readability over glass */
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 8px;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-content.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            cursor: pointer;
            color: var(--text-muted);
            border-radius: 6px;
            font-size: 0.85rem;
            transition: background 0.2s;
            user-select: none;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            margin: 0;
            cursor: pointer;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
            font-size: 0.9rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Charts */
        .chart-grid {
            display: grid;
            gap: 24px;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .chart-card {
            padding: 24px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-card h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-main);
        }

        .chart-toggle {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .chart-toggle.active {
            background: var(--accent);
            color: white;
            border-color: transparent;
        }

        /* Utilities */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 999px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border: 1px solid var(--glass-border);
        }

        .mono {
            font-family: var(--font-mono);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .top-nav {
                height: auto;
                flex-direction: column;
                padding: 16px;
                gap: 16px;
            }
            
            .nav-links {
                width: 100%;
                overflow-x: auto;
                padding: 4px;
                justify-content: flex-start;
            }
            
            .nav-links button {
                flex: 0 0 auto;
            }

            body {
                padding-top: 140px;
            }
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="nav-brand">
            <h1>{{ report_title }}</h1>
            <span id="reportDate" class="nav-date"></span>
        </div>
        <div class="nav-links" role="tablist">
            <button data-tab="leaderboard" class="active" role="tab">Leaderboard</button>
            <button data-tab="comparisons" role="tab">Score Comparisons</button>
            <button data-tab="cost" role="tab">Efficiency</button>
            <button data-tab="raw" role="tab">Raw Data</button>
        </div>
    </nav>

    <div class="container">
        <div class="hero">
            <p>{{ intro_text }}</p>
        </div>

        <section class="summary-grid">
            <article class="glass-card stat-card">
                <h3>Top Model</h3>
                <strong>{{ summary_data.top_model_by_score.replace('_filled', '') }}</strong>
            </article>
            <article class="glass-card stat-card">
                <h3>Models Benchmarked</h3>
                <strong>{{ summary_data.model_count }}</strong>
            </article>
        </section>

        <section id="leaderboard" class="tab-panel active">
            <div class="filters-bar glass-card">
                <div class="filter-group" id="filter-search">
                    <label for="leaderboardSearch">Search Models</label>
                    <input type="text" id="leaderboardSearch" placeholder="Filter by name..." />
                </div>
                <div class="filter-group" id="filter-arch">
                    <label>Architecture</label>
                    <div class="dropdown" id="archDropdown">
                        <button type="button" class="dropdown-btn" id="archFilterBtn" data-value="all">
                            <span id="archFilterText">All Architectures</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>
                        <div class="dropdown-content" id="archDropdownContent">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <div class="filter-group" id="filter-cols">
                    <label>Columns</label>
                    <div class="dropdown" id="columnDropdown">
                        <button type="button" class="dropdown-btn" id="columnDropdownBtn">
                            <span>Customize Columns</span>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </button>
                        <div class="dropdown-content" id="columnDropdownContent">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <div class="filter-group" id="filter-price">
                    <label>Price ($)</label>
                    <div class="size-inputs">
                        <input type="number" id="minPriceInput" placeholder="Min" step="0.01" min="0">
                        <span class="separator">-</span>
                        <input type="number" id="maxPriceInput" placeholder="Max" step="0.01" min="0">
                    </div>
                </div>
                <div class="filter-group" id="filter-size">
                    <label>Parameter Count (B)</label>
                    <div class="size-filter-container">
                        <div class="size-presets">
                            <button type="button" class="preset-btn active" data-min="0" data-max="1000">All</button>
                            <button type="button" class="preset-btn" data-min="0" data-max="7">&lt; 7B</button>
                            <button type="button" class="preset-btn" data-min="7" data-max="30">7B - 30B</button>
                            <button type="button" class="preset-btn" data-min="30" data-max="1000">30B+</button>
                        </div>
                        <div class="size-inputs">
                            <input type="number" id="minParamsInput" placeholder="Min" step="0.1" min="0">
                            <span class="separator">-</span>
                            <input type="number" id="maxParamsInput" placeholder="Max" step="0.1" min="0">
                        </div>
                    </div>
                </div>
                <div class="filter-group" id="filter-score">
                    <label>Min Score</label>
                    <div class="size-inputs">
                        <input type="number" id="minScoreInput" placeholder="0" min="0" max="100" step="1">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                <span class="badge">Visible: <strong id="leaderboardVisibleCount" style="color: var(--text-main); margin-left: 4px;">0</strong></span>
            </div>

            <div class="table-container">
                <table id="leaderboardTable">
                    <thead>
                        <tr>
                            {% for header in leaderboard_headers %}
                                <th data-key="{{ header }}">{{ header.replace('_', ' ') | title }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="comparisons" class="tab-panel">
            <div class="glass-card comparison-panel">
                <div class="comparison-header">
                    <div>
                        <h3>Compare Models</h3>
                        <p>Choose up to five models to visualize side-by-side.</p>
                    </div>
                    <span class="badge">Selected <strong id="selectedCount" style="color: var(--text-main);">0 / 5</strong></span>
                </div>
                <div class="comparison-search">
                    <input type="text" id="comparisonSearch" placeholder="Search models..." />
                </div>
                <div class="selected-models" id="selectedChips">
                    <p class="empty-state">No models selected.</p>
                </div>
                <div class="model-grid" id="comparisonGrid"></div>
                <div class="comparison-actions">
                    <button type="button" id="comparisonToggle">Show more</button>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Score Radar</h3>
                        <button type="button" class="chart-toggle" data-target="radarChart">Toggle View</button>
                    </div>
                    <div id="radarChart" style="height:400px;"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Category Breakdown</h3>
                        <button type="button" class="chart-toggle active" data-target="barChart">Toggle View</button>
                    </div>
                    <div id="barChart" style="height:400px;"></div>
                </div>
            </div>
        </section>

        <section id="cost" class="tab-panel">
            <div class="filters-bar glass-card" style="margin-bottom: 24px;">
                <div class="filter-group">
                    <label>Parameter Count (B)</label>
                    <div class="size-inputs">
                        <input type="number" id="effMinParams" placeholder="Min" step="0.1" min="0">
                        <span class="separator">-</span>
                        <input type="number" id="effMaxParams" placeholder="Max" step="0.1" min="0">
                    </div>
                </div>
                <div class="filter-group">
                    <label>Min Final Score</label>
                    <input type="number" id="effMinScore" placeholder="0" min="0" max="100" step="1">
                </div>
                <div class="filter-group">
                    <label>Max Cost / Score ($)</label>
                    <input type="number" id="effMaxCost" placeholder="Unlimited" min="0" step="0.01">
                </div>
            </div>
            <div class="glass-card" style="padding: 24px; margin-bottom: 24px;">
                <p style="margin: 0; color: var(--text-muted);">
                    Benchmarked prices represent vendor list prices at the time of authoring. 
                    Use final score alongside price to gauge value.
                </p>
            </div>
            <div class="table-container">
                <table class="cost-efficiency-table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Architecture</th>
                            <th>Price ($)</th>
                            <th>Final Score</th>
                            <th>Cost / Score</th>
                        </tr>
                    </thead>
                    <tbody id="costTableBody"></tbody>
                </table>
            </div>
        </section>

        <section id="raw" class="tab-panel">
            <div class="table-container" style="max-height: 800px; overflow-y: auto;">
                {{ table_html | safe }}
            </div>
        </section>
    </div>

    <script>
        const leaderboardData = JSON.parse('{{ leaderboard_json | escapejs }}');
        const radarSource = JSON.parse('{{ radar_json | escapejs }}');
        const summaryData = JSON.parse('{{ summary_json | escapejs }}');

        const paramValues = leaderboardData.map(row => Number(row.param_count || 0));
        const defaultMinParam = paramValues.length ? Math.floor(Math.min(...paramValues)) : 0;
        const defaultMaxParam = paramValues.length ? Math.ceil(Math.max(...paramValues)) : 0;

        const leaderboardTableBody = document.querySelector('#leaderboardTable tbody');
        const leaderboardVisibleCount = document.getElementById('leaderboardVisibleCount');
        const searchInput = document.getElementById('leaderboardSearch');
        
        // Arch Dropdown Elements
        const archFilterBtn = document.getElementById('archFilterBtn');
        const archFilterText = document.getElementById('archFilterText');
        const archDropdownContent = document.getElementById('archDropdownContent');

        const minParamsInput = document.getElementById('minParamsInput');
        const maxParamsInput = document.getElementById('maxParamsInput');
        const minPriceInput = document.getElementById('minPriceInput');
        const maxPriceInput = document.getElementById('maxPriceInput');
        const minScoreInput = document.getElementById('minScoreInput');
        const costTableBody = document.getElementById('costTableBody');
        const effMinParams = document.getElementById('effMinParams');
        const effMaxParams = document.getElementById('effMaxParams');
        const effMinScore = document.getElementById('effMinScore');
        const effMaxCost = document.getElementById('effMaxCost');
        const comparisonGrid = document.getElementById('comparisonGrid');
        const comparisonSearch = document.getElementById('comparisonSearch');
        const selectedChips = document.getElementById('selectedChips');
        const selectedCount = document.getElementById('selectedCount');
        const comparisonToggle = document.getElementById('comparisonToggle');

        // New Elements
        const columnDropdownBtn = document.getElementById('columnDropdownBtn');
        const columnDropdownContent = document.getElementById('columnDropdownContent');
        let tableHeaders = []; // Will hold [{key, label}]

        const MAX_COMPARISON_MODELS = 5;
        const COMPARISON_BATCH_SIZE = 10;
        let selectedModels = [];
        let showAllComparisonModels = false;

        function formatNumber(value, digits = 2) {
            if (value === null || value === undefined) return '';
            if (Math.abs(value) >= 1) {
                return value.toLocaleString(undefined, { maximumFractionDigits: digits });
            }
            return value.toFixed(digits);
        }

        function formatModelName(name) {
            if (!name) return '';
            return name.replace('_filled', '');
        }

        function populateArchitectureFilter() {
            const unique = new Set(['all']);
            leaderboardData.forEach(row => {
                if (row.architecture) {
                    unique.add(String(row.architecture));
                }
            });
            
            archDropdownContent.innerHTML = '';
            
            [...unique].forEach(arch => {
                const label = arch === 'all' ? 'All Architectures' : arch;
                
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = label;
                
                item.addEventListener('click', () => {
                    archFilterBtn.dataset.value = arch;
                    archFilterText.textContent = label;
                    archDropdownContent.classList.remove('show');
                    renderLeaderboard();
                    
                    // Update active state visually if needed
                    document.querySelectorAll('#archDropdownContent .dropdown-item').forEach(i => {
                        i.style.color = i === item ? 'var(--text-main)' : 'var(--text-muted)';
                    });
                });
                
                archDropdownContent.appendChild(item);
            });
            
            // Toggle logic
            archFilterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('.dropdown-content').forEach(el => {
                     if(el !== archDropdownContent) el.classList.remove('show');
                });
                archDropdownContent.classList.toggle('show');
            });
        }

        function renderLeaderboard() {
            const query = searchInput.value.trim().toLowerCase();
            const selectedArch = archFilterBtn.dataset.value;
            const minVal = Number(minParamsInput.value) || 0;
            const maxVal = Number(maxParamsInput.value) || Infinity;
            const minPrice = minPriceInput.value === '' ? 0 : Number(minPriceInput.value);
            const maxPrice = maxPriceInput.value === '' ? Infinity : Number(maxPriceInput.value);
            const minScore = Number(minScoreInput.value) || 0;

            const filtered = leaderboardData.filter(row => {
                const matchesSearch = row.model_name.toLowerCase().includes(query);
                const params = Number(row.param_count || 0);
                const price = Number(row.price || 0);
                const score = Number(row.final_score || 0);
                
                const matchesParams = params >= minVal && params <= maxVal;
                const matchesArch = selectedArch === 'all' || (row.architecture || '').toLowerCase() === selectedArch.toLowerCase();
                const matchesPrice = price >= minPrice && price <= maxPrice;
                const matchesScore = score >= minScore;
                
                return matchesSearch && matchesParams && matchesArch && matchesPrice && matchesScore;
            }).sort((a, b) => (b.final_score || 0) - (a.final_score || 0));

            leaderboardTableBody.innerHTML = '';
            filtered.forEach(row => {
                const tr = document.createElement('tr');
                
                // Iterate using known headers to ensure order and ability to hide
                tableHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.dataset.key = header.key;
                    
                    const value = row[header.key];
                    if (header.key === 'model_name') {
                        td.textContent = formatModelName(value);
                    } else if (typeof value === 'number') {
                        td.textContent = formatNumber(value);
                    } else {
                        td.textContent = value || '';
                    }
                    tr.appendChild(td);
                });
                
                leaderboardTableBody.appendChild(tr);
            });

            leaderboardVisibleCount.textContent = filtered.length;
        }

        function renderCostEfficiency() {
            const minParams = Number(effMinParams?.value) || 0;
            const maxParams = effMaxParams && effMaxParams.value !== '' ? Number(effMaxParams.value) : Infinity;
            const minScore = Number(effMinScore?.value) || 0;
            const maxCost = effMaxCost && effMaxCost.value !== '' ? Number(effMaxCost.value) : Infinity;

            const rows = leaderboardData
                .map(row => {
                    const price = Number(row.price || 0);
                    const score = Number(row.final_score || 0);
                    const params = Number(row.param_count || 0);
                    const costPerScore = score > 0 ? price / score : 0;
                    return { model: row.model_name, architecture: row.architecture || 'n/a', price, score, costPerScore, params };
                })
                .filter(row => {
                    const matchesParams = row.params >= minParams && row.params <= maxParams;
                    const matchesScore = row.score >= minScore;
                    const matchesCost = row.costPerScore <= maxCost;
                    return matchesParams && matchesScore && matchesCost;
                })
                .sort((a, b) => a.costPerScore - b.costPerScore);

            costTableBody.innerHTML = '';
            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatModelName(row.model)}</td>
                    <td>${row.architecture}</td>
                    <td class="mono">$${formatNumber(row.price)}</td>
                    <td>${formatNumber(row.score)}</td>
                    <td class="mono">${row.costPerScore ? '$' + formatNumber(row.costPerScore, 4) : '—'}</td>
                `;
                costTableBody.appendChild(tr);
            });
        }

        function renderSelectedChips() {
            selectedChips.innerHTML = '';
            selectedCount.textContent = `${selectedModels.length} / ${MAX_COMPARISON_MODELS}`;

            if (!selectedModels.length) {
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.textContent = 'No models selected.';
                selectedChips.appendChild(empty);
                return;
            }

            selectedModels.forEach(modelName => {
                const chip = document.createElement('span');
                chip.className = 'selected-chip';
                chip.innerHTML = `<span>${formatModelName(modelName)}</span>`;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.setAttribute('aria-label', `Remove ${formatModelName(modelName)}`);
                removeBtn.textContent = '×';
                removeBtn.addEventListener('click', () => {
                    selectedModels = selectedModels.filter(name => name !== modelName);
                    renderSelectedChips();
                    renderComparisonGrid();
                    renderCharts();
                });

                chip.appendChild(removeBtn);
                selectedChips.appendChild(chip);
            });
        }

        function toggleModelSelection(modelName) {
            const isSelected = selectedModels.includes(modelName);
            if (isSelected) {
                selectedModels = selectedModels.filter(name => name !== modelName);
            } else {
                if (selectedModels.length >= MAX_COMPARISON_MODELS) return;
                selectedModels.push(modelName);
            }
            renderSelectedChips();
            renderComparisonGrid();
            renderCharts();
        }

        function renderComparisonGrid() {
            if (!comparisonGrid) return;
            const query = comparisonSearch.value.trim().toLowerCase();
            const sorted = [...radarSource].sort((a, b) => (b.final_score || 0) - (a.final_score || 0));
            const filtered = sorted.filter(model =>
                model.model_name.toLowerCase().includes(query)
            );

            comparisonGrid.innerHTML = '';
            if (!filtered.length) {
                const empty = document.createElement('p');
                empty.className = 'empty-state';
                empty.style.gridColumn = '1 / -1';
                empty.textContent = 'No models match your search.';
                comparisonGrid.appendChild(empty);
                if (comparisonToggle) {
                    comparisonToggle.style.display = 'none';
                }
                return;
            }

            const shouldShowToggle = filtered.length > COMPARISON_BATCH_SIZE;
            const visibleModels = showAllComparisonModels ? filtered : filtered.slice(0, COMPARISON_BATCH_SIZE);

            visibleModels.forEach(model => {
                const option = document.createElement('div');
                option.className = 'model-option';
                option.setAttribute('role', 'button');
                option.setAttribute('tabindex', '0');
                option.innerHTML = `
                    <span>${formatModelName(model.model_name)}</span>
                    <span class="option-score">${formatNumber(model.final_score)}</span>
                `;

                if (selectedModels.includes(model.model_name)) {
                    option.classList.add('selected');
                } else if (selectedModels.length >= MAX_COMPARISON_MODELS) {
                    option.classList.add('disabled');
                }

                option.addEventListener('click', () => {
                    if (option.classList.contains('disabled') && !selectedModels.includes(model.model_name)) return;
                    toggleModelSelection(model.model_name);
                });

                option.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        if (option.classList.contains('disabled') && !selectedModels.includes(model.model_name)) return;
                        toggleModelSelection(model.model_name);
                    }
                });

                comparisonGrid.appendChild(option);
            });

            if (comparisonToggle) {
                if (!shouldShowToggle) {
                    comparisonToggle.style.display = 'none';
                } else {
                    comparisonToggle.style.display = 'inline-flex';
                    const remaining = filtered.length - visibleModels.length;
                    comparisonToggle.textContent = showAllComparisonModels ? 'Show less' : `Show more (${remaining})`;
                }
            }
        }

        function renderCharts() {
            const radarChartEl = document.getElementById('radarChart');
            const barChartEl = document.getElementById('barChart');
            const selected = selectedModels;

            if (!selected.length) {
                radarChartEl.innerHTML = '<p class="empty-state">Select models to view the radar chart.</p>';
                barChartEl.innerHTML = '<p class="empty-state">Select models to view category breakdown.</p>';
                return;
            }
            const categories = ['entity_score', 'dev_score', 'community_score', 'technical_score'];
            const readable = {
                entity_score: 'Entity',
                dev_score: 'Developer',
                community_score: 'Community',
                technical_score: 'Technical',
            };

            const chosen = radarSource.filter(item => selected.includes(item.model_name));
            const radarTraces = chosen.map(item => ({
                type: 'scatterpolar',
                r: categories.map(cat => item[cat] || 0),
                theta: categories.map(cat => readable[cat]),
                fill: 'toself',
                name: formatModelName(item.model_name),
            }));

            const commonLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#f4f4f5', family: 'Inter, sans-serif' },
                margin: { t: 30, b: 40, l: 40, r: 40 },
                legend: { orientation: 'h', y: -0.15 },
            };

            Plotly.newPlot('radarChart', radarTraces, {
                ...commonLayout,
                polar: { 
                    bgcolor: 'rgba(0,0,0,0)',
                    radialaxis: { visible: true, range: [0, Math.max(1, ...radarTraces.flatMap(trace => trace.r) || [1])], gridcolor: '#333' },
                    angularaxis: { gridcolor: '#333' }
                },
            }, { responsive: true, displayModeBar: false });

            const barTraces = categories.map(cat => ({
                type: 'bar',
                name: readable[cat],
                x: chosen.map(item => formatModelName(item.model_name)),
                y: chosen.map(item => item[cat] || 0),
            }));

            Plotly.newPlot('barChart', barTraces, {
                ...commonLayout,
                barmode: 'group',
                yaxis: { title: 'Score', gridcolor: '#333' },
                xaxis: { gridcolor: '#333' }
            }, { responsive: true, displayModeBar: false });
        }

        // Updated selector for nav links
        document.querySelectorAll('.nav-links button').forEach(button => {
            button.addEventListener('click', () => {
                const target = button.dataset.tab;
                
                // Update button states
                document.querySelectorAll('.nav-links button').forEach(btn => {
                    btn.classList.toggle('active', btn === button);
                });
                
                // Update panel states
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.toggle('active', panel.id === target);
                });
                
                // Refresh charts if showing comparisons
                if (target === 'comparisons') {
                    renderCharts();
                    window.dispatchEvent(new Event('resize'));
                }
            });
        });

        // Chart toggles (Radar/Bar specific view toggling if desired, though now we show both)
        // Preserving the logic in case user wants to hide/show specifically, 
        // but the new layout shows both side-by-side. 
        // We can simplify to just refresh charts on resize.
        document.querySelectorAll('.chart-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                const chartDiv = document.getElementById(targetId);
                if(chartDiv.style.display === 'none') {
                    chartDiv.style.display = 'block';
                    btn.classList.add('active');
                } else {
                    chartDiv.style.display = 'none';
                    btn.classList.remove('active');
                }
                window.dispatchEvent(new Event('resize'));
            });
        });

        [searchInput, minParamsInput, maxParamsInput, minPriceInput, maxPriceInput, minScoreInput, effMinParams, effMaxParams, effMinScore, effMaxCost].forEach(control => {
            control.addEventListener('input', () => {
                if (control === minParamsInput || control === maxParamsInput) {
                    document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                }

                if (control === effMinParams || control === effMaxParams || control === effMinScore || control === effMaxCost) {
                    renderCostEfficiency();
                } else {
                    renderLeaderboard();
                }
            });
        });

        if (comparisonSearch) {
            comparisonSearch.addEventListener('input', () => {
                showAllComparisonModels = false;
                renderComparisonGrid();
            });
        }

        if (comparisonToggle) {
            comparisonToggle.addEventListener('click', () => {
                showAllComparisonModels = !showAllComparisonModels;
                renderComparisonGrid();
            });
        }

        function seedComparisonSelection() {
            if (selectedModels.length || !radarSource.length) return;
            selectedModels = [...radarSource]
                .sort((a, b) => (b.final_score || 0) - (a.final_score || 0))
                .slice(0, Math.min(3, MAX_COMPARISON_MODELS, radarSource.length))
                .map(model => model.model_name);
        }

        // Preset buttons logic
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Set values
                const min = btn.dataset.min;
                const max = btn.dataset.max;
                minParamsInput.value = min;
                // If max is 1000, we can clear the input or set it high. Let's set it to empty for "infinity" effect or high value
                maxParamsInput.value = max === '1000' ? '' : max;
                
                renderLeaderboard();
            });
        });

        function setupColumnToggler() {
            // Read headers from DOM
            const thElements = document.querySelectorAll('#leaderboardTable th');
            tableHeaders = Array.from(thElements).map(th => ({
                key: th.dataset.key,
                label: th.textContent
            }));

            // Create dynamic style element for toggling
            const style = document.createElement('style');
            style.id = 'column-visibility-styles';
            document.head.appendChild(style);

            // Default visible columns
            const defaultColumns = ['model_name', 'param_count', 'input_price', 'output_price', 'final_score'];

            // Populate Dropdown
            columnDropdownContent.innerHTML = '';
            tableHeaders.forEach(header => {
                const label = document.createElement('label');
                label.className = 'dropdown-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = defaultColumns.includes(header.key);
                checkbox.dataset.key = header.key;
                
                checkbox.addEventListener('change', updateColumnVisibility);
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(header.label));
                columnDropdownContent.appendChild(label);
            });

            // Apply initial visibility
            updateColumnVisibility();

            // Dropdown Toggle Logic
            columnDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                columnDropdownContent.classList.toggle('show');
            });

            // Close dropdown when clicking outside (General handler)
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    if (!dropdown.contains(e.target)) {
                        dropdown.querySelector('.dropdown-content')?.classList.remove('show');
                    }
                });
            });
        }

        function updateColumnVisibility() {
            const style = document.getElementById('column-visibility-styles');
            const checkboxes = columnDropdownContent.querySelectorAll('input[type="checkbox"]');
            
            const hiddenKeys = [];
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    hiddenKeys.push(cb.dataset.key);
                }
            });

            // Generate CSS rules to hide columns
            if (hiddenKeys.length > 0) {
                const selectors = hiddenKeys.map(key => 
                    `#leaderboardTable th[data-key="${key}"], #leaderboardTable td[data-key="${key}"]`
                ).join(',\n');
                style.textContent = `${selectors} { display: none; }`;
            } else {
                style.textContent = '';
            }
        }

        function initialise() {
            setupColumnToggler(); // Setup headers and toggler first

            // Format date
            if (summaryData.generated_at) {
                const date = new Date(summaryData.generated_at);
                // If valid date, format it nicely. Otherwise fallback to original string.
                if (!isNaN(date.getTime())) {
                    document.getElementById('reportDate').textContent = date.toLocaleDateString(undefined, { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    document.getElementById('reportDate').textContent = summaryData.generated_at;
                }
            }

            minParamsInput.value = defaultMinParam;
            maxParamsInput.value = defaultMaxParam;

            populateArchitectureFilter();
            seedComparisonSelection();
            renderSelectedChips();
            renderComparisonGrid();
            renderLeaderboard();
            renderCostEfficiency();
            renderCharts();
        }

        document.addEventListener('DOMContentLoaded', initialise);
    </script>
</body>
</html>
